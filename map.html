<!DOCTYPE html>
<html lang="html5">
<head>
  <title>Canvas Page</title>
  <style>
      #canvas {
          border: 1px solid black;
      }
  </style>
</head>
<body>
<canvas id="canvas" width="800" height="600"></canvas>
<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let data = null;

    const triangleSize = 0.02; // 5% of the smaller dimension
    let triangleWidth = Math.min(canvas.width, canvas.height) * triangleSize;
    let triangleHeight = 2 * triangleWidth; // height is double the width

    async function fetchData() {
        try {
            const response = await fetch('http://localhost:8223');
            data = await response.json();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function drawTriangle(x, y, dx, dy, username, altitude) {
        ctx.beginPath();

        // Translate and rotate the canvas to draw each triangle
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(Math.atan2(dy, dx) + Math.PI / 2); // rotate 90 degrees clockwise

        // Adjust triangle drawing to center
        ctx.moveTo(0, -triangleHeight / 3);
        ctx.lineTo(-triangleWidth / 2, triangleHeight * 2 / 3);
        ctx.lineTo(triangleWidth / 2, triangleHeight * 2 / 3);
        ctx.closePath();

        ctx.fillStyle = 'black';
        ctx.fill();

        // Restore the canvas state
        ctx.restore();

        // Draw the username and altitude
        ctx.fillStyle = 'blue';
        ctx.fillText(username, x, y - triangleHeight / 2 - 10);
        ctx.fillText(`Altitude: ${altitude}`, x, y - triangleHeight / 2 - 25);
    }

    function updateCanvas() {
        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw each player's triangle
        for (const player in data) {
            let {x, y, dx, dy, alt} = data[player];

            // Swap dx and dy and change the sign of dy to rotate 90 degrees clockwise
            // [dx, dy] = [dy, -dx];

            drawTriangle(
                x * canvas.width,
                y * canvas.height,
                dx,
                dy,
                player,
                alt
            );
        }
    }

    // Fetch data every second and update the canvas
    setInterval(async () => {
        await fetchData();
        updateCanvas();
    }, 500);


</script>
</body>
</html>
